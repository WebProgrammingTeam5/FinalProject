<html>
  <head>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;500;600;700&display=swap" rel="stylesheet"> -->

    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <style>
      *{
        font-family: Arial, Helvetica, sans-serif;
        overflow: hidden;
      }
      #parent {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: row;
      }
      #leftBar {
        width: 20%;
        /* height: 100%; */
        display: flex;
        flex-direction: column;
        align-items: center;
        position: fixed;
        top: 0;
        left: 0;
        border: 0.5px solid blac햐k;
      }
      #interface{
        width: 100%;
        height: 100%;
        padding: 20%;
        display: flex;
        justify-content: center;
        text-align: center;
      }
      #map {
      }
      #box{
        width: 10px;
        height: 10px;
        border: 0.5px solid black;
      }
      #selectedBox{
        width: 10px;
        height: 10px;
        border: 0.5px solid black;
        background-color:darkgoldenrod;
      }
      tr{
        display: flex;
        flex-direction: row;
      }
      #status{
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #itemBox{
        height: 50px;
        margin: 10px 0px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color:khaki;
      }
      #control{
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  
  <body id="parent">
      <div id="leftBar">
        <h2>LEVEL <span id="level"></span> <span id="name"></span></h2>
        <h3>현재 위치</h3>
        <table id="map" >
        </table>
        <div id="status">
         <div id="HP"></div>
         <div id="STR"></div>
         <div id="DEF"></div>
         <h3>인벤토리</h3>
         <div id="inventory"></div>
        </div>
        <button
              onclick="{localStorage.removeItem('_key'); location.href='/';}"
            >
              로그아웃
            </button>
      </div>
      <div id="interface">
        <div>
          <div id="game"></div>
          <div id="monster" style="white-space: pre"></div>
          <div id="event_result"></div>
          <div id="control"></div>
          <div>
            
          </div>
        </div>
      </div>
    </div>

    <script>
      const sendAction = (url, params = {}) => {
        $.ajax({
          url,
          headers: {
            Authorization: 'Bearer ' + key,
          },
          method: 'POST',
          data: $.param(params),
        }).done((req) => {
          const { player, field, event, actions } = req;
          if (player.HP <= 0) {
            location.href = '/dead';
          }
          $('#map').html('');
          for (let i = 0; i < 10; i++) {
            const row = $(`<tr></tr>`);
            for (let j = 0; j < 10; j++) {
              if (j === field.x && i === 9 - field.y) {
                const box = $('<div id="selectedBox"></div>');
                row.append(box);
              } else {
                const box = $('<div id="box"></div>');
                row.append(box);
              };
            }
            $('#map').append(row);
          }
          $('#game').text(field.description);
          $('#STR').text(`공격력: ${player.str}`);
          $('#DEF').text(`방어력: ${player.def}`);
          $('#HP').text(`체력 : ${player.HP} / ${player.maxHP}`);

          $('#level').text(player.level);
          $('#name').text(player.name);

          $('#control').html('');
          req.actions.forEach((action) => {
            const dom = $('<button></button>');
            dom.text(action.text);
            dom.bind('click', function () {
              sendAction(action.url, action.params);
            });
            $('#control').append(dom);
          });
          $('#inventory').html('');
          req.player.item.forEach((item) => {
            const itemBox = $('<div id="itemBox"></div>');
            itemBox.text(item.name);
            $('#inventory').append(itemBox);
          });

          if (event) {
            if (event.monster) {
              $('#monster').show();
              $('#monster').text(event.monster);
            } else {
              $('#monster').hide();
            }
            $('#event_result').text(event.description);
          } else {
            $('#event_result').text('아무일도 일어나지 않았다.');
          }

        });
      };
      const key = localStorage.getItem('_key');
      if (!key) {
        location.href = '/';
      }

      sendAction('/action', { action: 'query' });
    </script>
  </body>
</html>
